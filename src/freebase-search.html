<!-- Import Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="freebase-search" attributes="limit domain">




    <template>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <link href="freebase-search.css" rel="stylesheet" />
        <div id="typeahead">
            <input on-keyup="{{inputTextKeyup}}" id="inputText" type="text" value="{{searchText}}"><br>
            <ul id="list" style="display: {{showTypeahead}}">
                <template repeat="{{r in results}}">
                    <li on-click="{{itemClick}}" class="{{r.clazz}}" name="{{r.name}}" image="{{r.image}}"><div class="result-item"><div class="col1"><div class="circular" _style = 'background-image: url({{r.imageUrl}});'></div></div><div class="col2"><span class="inputName">{{r.name}}</span><br/><span class="inputCategory">{{r.notable}}</span><div></div></li>
                </template>
            </ul>
        </div>
        <img _src="{{resultImage}}" alt="">
    </template>

    <!-- Import JQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>

    <script>
        Polymer('freebase-search', {
            ready: function() {
                var list = $(this.$.list);
                if(list.children('li')) {
                    list.children('li').first().addClass('active');
                }
            },
            itemClick: function(event, detail, sender) {
                var image = $(sender).attr('image');
                var name = $(sender).attr('name');
                if(!!image) {
                    this.resultImage = 'https://www.googleapis.com/freebase/v1/image' + image + '?key=AIzaSyCQVC9yA72POMg2VjiQhSJQQP1nf3ToZTs&maxwidth=160';
                } else {
                    this.resultImage = 'http://placehold.it/160&text=no+image';
                }

                this.searchText = name;

                this.showTypeahead = 'none';

                this.$.inputText.blur();

                this.preventSearch = true;
            },
            inputTextKeyup: function(e) {
                var list = $(this.$.list);
                var actual = list.children('li.active');
                var image, name;
                switch(e.keyCode) {
                    case 13: // enter
                        image = actual.attr('image');
                        name = actual.attr('name');
                        if(!!image) {
                            this.resultImage = 'https://www.googleapis.com/freebase/v1/image' + image + '?key=AIzaSyCQVC9yA72POMg2VjiQhSJQQP1nf3ToZTs&maxwidth=160';
                        } else {
                            this.resultImage = 'http://placehold.it/160&text=no+image';
                        }

                        this.searchText = name;

                        this.showTypeahead = 'none';

                        this.$.inputText.blur();

                        this.preventSearch = true;

                        break;
                    case 40: // down
                        e.preventDefault();
                        var next = actual.next('li');
                        if (next.length > 0) {
                            actual.removeClass('active');
                            next.addClass('active');
                            image = next.attr('image');
                        } else {
                            image = actual.attr('image');
                        }


                        if(!!image) {
                            this.resultImage = 'https://www.googleapis.com/freebase/v1/image' + image + '?key=AIzaSyCQVC9yA72POMg2VjiQhSJQQP1nf3ToZTs&maxwidth=160';
                        } else {
                            this.resultImage = 'http://placehold.it/160&text=no+image';
                        }

                        break;
                    case 38: //up
                        e.preventDefault();
                        var prev = actual.prev('li');
                        if (prev.length > 0) {
                            actual.removeClass('active');
                            prev.addClass('active');
                            image = prev.attr('image');
                        } else {
                            image = actual.attr('image');
                        }

                        if(!!image) {
                            this.resultImage = 'https://www.googleapis.com/freebase/v1/image' + image + '?key=AIzaSyCQVC9yA72POMg2VjiQhSJQQP1nf3ToZTs&maxwidth=160';
                        } else {
                            this.resultImage = 'http://placehold.it/160&text=no+image';
                        }
                        break;
                }
            },
            searchText: '',
            domain: '',
            preventSearch: false,
            limit: 4,
            key: 'AIzaSyCQXvFx7PMLEImgshuRNJ_vlngLBCTVxkA',
            results: [],
            showTypeahead: 'none',
            resultImage: 'http://placehold.it/160&text=no+image',
            searchTextChanged: function() {
                if(this.preventSearch) {
                    this.preventSearch = false;
                    return;
                }

                if(this.searchText.length < 3) {
                    this.results = [];
                    this.resultImage = 'http://placehold.it/160&text=no+image';
                    this.showTypeahead = 'none';
                    return;
                }

                var searchDomain = '';
                if(this.domain) {
                    searchDomain = '(any type:' + this.domain + ')';
                }

                var that = this;
                $.ajax({
                    url: 'https://www.googleapis.com/freebase/v1/search?callback=?&key=' + this.key,
                    dataType: 'jsonp',
                    data: {
                      query: this.searchText,
                      exact: false,
                      output: '(all)',
                      filter: searchDomain,
                      limit: this.limit,
                      prefixed: true
                    },
                    success: function(data) {
                      console.log(data);

                      var result = data.result;
                      that.results = [];
                      for (var i = 0; i < result.length; i++) {
                        if (result[i].name && result[i].notable && result[i].notable.name) {
                          that.results.push({
                              name: result[i].name,
                              notable: result[i].notable.name,
                              clazz: i === 0 ? 'active' : '',
                              image: result[i].output.all['property./common/topic/image'] ? result[i].output.all['property./common/topic/image'][0].mid : '',
                              imageUrl: result[i].output.all['property./common/topic/image'] ? 'https://www.googleapis.com/freebase/v1/image' + result[i].output.all['property./common/topic/image'][0].mid + '?key=AIzaSyCQVC9yA72POMg2VjiQhSJQQP1nf3ToZTs&maxwidth=33' : 'http://placehold.it/160&text=no+image'
                          });
                        }
                      }

                      if (that.results.length > 0) {
                          that.showTypeahead = 'block';
                      } else {
                          that.showTypeahead = 'none';
                      }

                      if (result.length > 0 && result[0].output.all[
                        'property./common/topic/image']) {
                        var mid = result[0].output.all['property./common/topic/image'][0].mid;

                        that.resultImage = 'https://www.googleapis.com/freebase/v1/image' + mid + '?key=AIzaSyCQVC9yA72POMg2VjiQhSJQQP1nf3ToZTs&maxwidth=160';
                      } else {
                        that.resultImage = 'http://placehold.it/160&text=no+image';
                      }

                    }
                });
            }
        });
    </script>
</polymer-element>
